from __future__ import annotations

from copy import deepcopy
from typing import Any, Dict


DEFAULT_LANGUAGE = "en"


_LANGUAGE_PACKS: Dict[str, Dict[str, Any]] = {
    "en": {
        "language_name": "English",
        "app": {"title": "SF Integrator"},
        "nav": {
            "brand": "SF Integrator",
            "query": "Query",
            "org_config": "Org Configuration",
            "data_import": "Data Import All Files",
            "account_explorer": "Account Explorer",
            "guide": "Guide",
            "settings": "Settings",
        },
        "index": {
            "select_org": {
                "title": "Select an org",
                "description": "Choose a configured org to run SOQL queries.",
                "connected_badge": "Connected",
                "not_connected_badge": "Not connected",
                "empty": "No orgs yet. Add one from the org configuration page.",
                "manage_button": "Manage orgs",
            },
            "help": {
                "title": "Need help?",
                "description": "Follow the configuration checklist.",
                "guide_button": "View guide",
            },
            "query": {
                "title": "SOQL Explorer",
                "selected_org_label": "Selected Org",
                "selected_org_placeholder": "Select an org",
                "soql_label": "SOQL Query",
                "soql_placeholder": "SELECT Id\nFROM Account",
                "run_button": "Run query",
                "run_button_bypass": "Run without LIMIT/WHERE",
                "run_button_fetch_all": "Run up to 500k records",
                "helpers": {
                    "add_limit": "Add LIMIT 100",
                    "add_order_by": "Add ORDER BY CreatedDate DESC",
                },
                "saved_queries": {
                    "title": "Saved Queries",
                    "name_label": "Name",
                    "name_placeholder": "My SOQL query",
                    "save_button": "Save query",
                    "update_button": "Update query",
                    "reset_button": "Clear",
                    "empty": "No saved queries yet.",
                    "load_button": "Load",
                    "delete_button": "Delete",
                },
                "history": {
                    "title": "Query history",
                    "filter_label": "Filter by object",
                    "filter_all": "All objects",
                    "empty": "No queries run yet.",
                    "object_unknown": "Unknown object",
                    "org_label": "Org",
                },
                "suggestions": {
                    "title": "Suggested fields",
                    "empty": "No suggestions available.",
                    "field_exists_toast": '"{field}" is already present in the SELECT clause',
                },
                "autocomplete": {
                    "title": "Autocomplete",
                    "objects_label": "Objects",
                    "objects_placeholder": "Filter objects",
                    "objects_empty": "Select an org to load objects.",
                    "fields_label": "Fields",
                    "fields_empty": "Select an object to view fields.",
                    "loading": "Loading...",
                },
            },
        },
        "data_import": {
            "title": "Data Import All Files",
            "subtitle": "Load exported Salesforce files to explore how Accounts relate to other records.",
            "upload": {
                "optional": "Optional",
                "instructions": "Upload an exported file to make this object available in the explorer.",
                "select_label": "Upload file",
                "not_loaded": "No file loaded yet.",
                "file_label": "File",
                "record_count": "Records",
                "updated_at": "Loaded",
                "remove_button": "Remove data",
                "loaded_badge": "Loaded",
            },
            "search": {
                "title": "Relationship explorer",
                "object_label": "Object",
                "field_label": "Field",
                "value_label": "Value",
                "value_placeholder": "Type a value to search",
                "submit": "Show related",
                "reset": "Clear",
            },
            "results": {
                "title": "Related records",
                "placeholder": "Load files and run a search to explore the relationships.",
                "select_record": "Select a record to view its fields.",
                "empty_object": "No records available for this object.",
                "fields_heading": "Fields",
                "related_heading": "Linked records",
                "related_empty": "No linked records for this record.",
                "match_badge": "Search match",
            },
        },
        "account_explorer": {
            "title": "Account Relationship Explorer",
            "input": {
                "title": "Load Account IDs",
                "description": "Upload a file or paste a list of Account IDs (up to {limit}).",
                "file_label": "Import from file",
                "file_help": "Supports CSV or Excel files containing an Id column.",
                "text_label": "Paste Account IDs",
                "text_help": "Separate multiple IDs with commas, spaces, or new lines.",
                "parse_button": "Load IDs",
                "clear_button": "Clear",
                "preview_title": "Selected Account IDs",
                "preview_empty": "No account IDs loaded yet.",
                "preview_more": "+ {extra} more IDs not shown",
            },
            "run": {
                "title": "Run explorer",
                "org_label": "Salesforce org",
                "org_placeholder": "Select an org",
                "org_help": "Choose a connected org to retrieve related records.",
                "button": "Run explorer",
                "download": "Download JSON",
                "status_running": "Loading related records…",
                "generated_at": "Data generated {timestamp}",
            },
            "results": {
                "title": "Related data",
                "placeholder": "Load account IDs and run the explorer to view results.",
                "select_account": "Select an account to view its relationships.",
                "fields_heading": "Account fields",
                "related_heading": "Related objects",
                "empty_object": "No related records found.",
                "missing_accounts": "Missing {count} account(s): {ids}",
                "accounts_badge": "{count} accounts",
                "no_fields": "No fields configured.",
                "no_id": "No Id",
                "no_objects": "No objects selected for display.",
                "open_wide_tree": "Open wide tree view in new tab",
                "tree_tab_title": "{account} — Tree view",
                "account_label": "Account",
                "view": {
                    "label": "Results view",
                    "list": "List",
                    "tree": "Tree",
                },
            },
            "setup": {
                "button": "Set up",
                "title": "Set up explorer",
                "description": "Customize the objects and fields shown in the explorer.",
                "objects_title": "Objects",
                "objects_help": "Reorder the objects and choose which ones are visible. Hidden objects are still queried.",
                "objects_empty": "No objects available.",
                "move_up": "Move up",
                "move_down": "Move down",
                "show_label": "Show",
                "hidden_badge": "Hidden",
                "fields_title": "Fields",
                "fields_help": "Select up to five fields to display for each object.",
                "field_placeholder": "Field {index}",
                "org_label": "Field suggestions org",
                "org_placeholder": "Select an org (optional)",
                "org_help": "Used to load autocomplete suggestions when editing fields.",
                "alerts": {
                    "title": "Alerts",
                    "description": "Highlight accounts when related records match custom conditions.",
                    "guide_link": "Read the alerts guide",
                    "add_alert": "Add alert",
                    "label": "Alert label",
                    "object": "Object",
                    "object_placeholder": "Select an object",
                    "field": "Field",
                    "operator": "Operator",
                    "value": "Value",
                    "value_placeholder": "Enter a value",
                    "remove_alert": "Remove alert",
                    "remove_filter": "Remove filter",
                    "add_filter": "Add filter",
                    "empty": "No alerts configured yet.",
                    "operators": {
                        "equals": "equals",
                        "equals_ignore_case": "equals (ignore case)",
                        "not_equals": "not equals",
                        "contains": "contains",
                        "not_contains": "does not contain",
                        "starts_with": "starts with",
                        "blank": "is blank",
                        "not_blank": "is not blank",
                        "null": "is null",
                        "not_null": "is not null",
                    },
                },
                "view_title": "Default view",
                "view_help": "Choose how results should display by default.",
                "view_options": {"list": "List", "tree": "Tree"},
                "contact_points": {
                    "title": "Contact point matching",
                    "description": "Choose how Contact Point records are matched to related records.",
                    "options": {
                        "contact": "Match via Contact__c",
                        "individual": "Match via ParentId",
                    },
                },
                "close": "Close",
                "save_button": "Save configuration",
                "saving": "Saving…",
                "saved": "Configuration saved.",
                "save_failed": "Unable to save the configuration.",
            },
        },
        "orgs": {
            "form": {
                "title": "Add or update an org",
                "id_label": "Org ID",
                "id_placeholder": "unique-id",
                "id_help": "Use a unique identifier (e.g. prod, sandbox1).",
                "label_label": "Display name",
                "label_placeholder": "Production Org",
                "environment_label": "Environment",
                "environment_production": "Production (login.salesforce.com)",
                "environment_sandbox": "Sandbox (test.salesforce.com)",
                "environment_custom": "Custom Domain",
                "environment_custom_placeholder": "https://your-domain.my.salesforce.com",
                "environment_help": "Select custom to use a My Domain login URL.",
                "client_id_label": "Consumer Key (Client ID)",
                "client_secret_label": "Consumer Secret",
                "client_secret_help": "Leave blank to keep the existing secret when editing.",
                "redirect_uri_label": "Redirect URI",
                "redirect_uri_placeholder": "https://yourapp.com/oauth/callback",
                "scope_label": "OAuth Scope",
                "scope_default": "full refresh_token",
                "save_button": "Save org",
                "clear_button": "Clear form",
                "update_button": "Update org",
            },
            "table": {
                "title": "Configured orgs",
                "empty": "No orgs configured yet.",
                "headers": {
                    "id": "ID",
                    "label": "Label",
                    "environment": "Environment",
                    "status": "Status",
                    "actions": "",
                },
                "connected_badge": "Connected",
                "not_connected_badge": "Not connected",
                "actions": {
                    "connect": "Connect",
                    "edit": "Edit",
                    "delete": "Delete",
                },
            },
        },
        "guide": {
            "title": "Salesforce OAuth Integration Checklist",
            "subtitle": "Follow these steps to connect this app with your Salesforce org.",
            "sections": {
                "prepare": {
                    "title": "1. Prepare Salesforce",
                    "steps": [
                        "Sign in to the Salesforce org that you want to integrate.",
                        "Navigate to <strong>Setup &gt; Apps &gt; App Manager</strong> and click <strong>New Connected App</strong> (Lightning Experience) rather than <em>New Lightning App</em> or <em>New External Client App</em>.",
                        "Fill out the basic information section: enter a descriptive <strong>Connected App Name</strong>, allow Salesforce to auto-populate the <strong>API Name</strong>, and provide a <strong>Contact Email</strong>; the remaining optional fields can stay blank unless your org requires them.",
                        "Enable <strong>OAuth Settings for API Integration</strong> to reveal the integration options.",
                        "Within the OAuth settings, leave <strong>Require Secret for Web Server Flow</strong> checked, keep the default <strong>Selected OAuth Scopes</strong> list empty for now, and skip optional fields such as <em>Start URL</em> or <em>Callback URL for Lightning Apps</em>.",
                        "Set the primary <strong>Callback URL</strong> to <code>http://localhost:5000/oauth/callback</code> for local development; when deploying, replace <code>localhost:5000</code> with your host name while keeping the path <code>/oauth/callback</code>.",
                        "Add the following OAuth scopes to the <strong>Selected OAuth Scopes</strong> list: <code>Full access (full)</code> and <code>Perform requests on your behalf at any time (refresh_token, offline_access)</code>. Other scopes can remain unselected unless your integration needs them.",
                        "Save the connected app and copy the <strong>Consumer Key</strong> and <strong>Consumer Secret</strong>.",
                        "Under <strong>Manage &gt; OAuth Policies</strong>, ensure that the refresh token policy allows refresh token usage.",
                    ],
                },
                "configure": {
                    "title": "2. Configure the integrator",
                    "steps": [
                        "Open the <a href=\"{org_config_url}\">Org Configuration</a> page.",
                        "Fill in the form with:",
                        "Click <strong>Save org</strong>.",
                        "Use the <strong>Connect</strong> button in the table to start OAuth authorization.",
                        "Grant access in Salesforce when prompted; you will be redirected back to the app.",
                    ],
                    "form_details": [
                        "<strong>Org ID</strong>: an internal identifier such as <code>prod</code> or <code>dev</code>.",
                        "<strong>Display name</strong>: friendly name shown in the UI.",
                        "<strong>Environment</strong>: choose Production, Sandbox, or enter your custom My Domain URL.",
                        "<strong>Consumer Key</strong> and <strong>Consumer Secret</strong> from the connected app.",
                        "<strong>Redirect URI</strong>: must match the callback URL configured in Salesforce.",
                        "<strong>OAuth Scope</strong>: default is <code>full refresh_token</code>; adjust if needed.",
                    ],
                },
                "query": {
                    "title": "3. Run SOQL queries",
                    "steps": [
                        "Return to the <a href=\"{query_url}\">Query</a> page.",
                        "Select the org you just authorized and paste a SOQL query, e.g. <code>SELECT Id, Name FROM Account LIMIT 10</code>.",
                        "Click <strong>Run query</strong> to execute. Results appear in a table below the form.",
                        "Need more data? Use the <strong>Run without LIMIT/WHERE</strong> button to bypass safeguards or <strong>Run up to 500k records</strong> to fetch a larger data set.",
                    ],
                },
                "account_alerts": {
                    "title": "4. Account Explorer alerts",
                    "intro": "Use alerts to flag accounts and related records when they meet the checks you care about.",
                    "steps": [
                        "Open the <strong>Account Explorer</strong> and click <strong>Set up</strong>.",
                        "Scroll to the <strong>Alerts</strong> section and select <strong>Add alert</strong> to create a rule.",
                        "Enter a descriptive alert label and add one or more filters. Each filter includes Object, Field, Operator, and Value inputs (leave Value blank for operators such as <em>is blank</em> or <em>is null</em>).",
                        "Use autocomplete to target complex conditions—for example check <code>Contact.Phone</code> for blanks, compare roles, or validate SOL-specific email types.",
                        "Save the configuration. When the explorer runs, matching accounts, records, and fields turn red and display the alert reason on hover.",
                    ],
                },
                "advanced": {
                    "title": "5. Handle large result sets",
                    "steps": [
                        "Choose <strong>Run without LIMIT/WHERE</strong> to run ad-hoc queries that skip the default validation when you trust the SOQL.",
                        "Use <strong>Run up to 500k records</strong> to request more data via the Salesforce QueryAll API (up to 500,000 records) and plan for longer execution times.",
                    ],
                },
            },
            "tip": {
                "title": "Tip:",
                "content": "For local development, set your callback URL to <code>http://localhost:5000/oauth/callback</code> and add it to the connected app's list of allowed callbacks. When deploying, update the host name to match your environment but keep the path <code>/oauth/callback</code> so the redirect completes successfully.",
            },
        },
        "settings": {
            "title": "Settings",
            "language_label": "Language",
            "theme_label": "Theme",
            "save_button": "Save settings",
            "saved": "Settings updated successfully.",
            "account_explorer": {
                "title": "Account explorer fields",
                "description": "Select up to five fields per object to display in the explorer results (runs are limited to {limit} accounts).",
                "org_label": "Field suggestions org",
                "org_placeholder": "Select an org (optional)",
                "org_help": "Used to provide autocomplete suggestions when editing fields.",
                "field_help": "Choose up to five fields to show per object.",
                "field_placeholder": "Field {index}",
                "save_button": "Save field selections",
                "reset_button": "Reset",
                "loading": "Loading configuration…",
                "load_failed": "Unable to load the current configuration.",
                "saved": "Field configuration saved.",
                "save_failed": "Unable to save the field configuration.",
                "toast_saved": "Account explorer fields saved.",
            },
            "themes": {
                "classic": "Classic",
                "modern": "Modern",
                "dark": "Dark",
                "sci-fi": "Sci-fi",
            },
        },
        "frontend": {
            "toast": {
                "select_org": "Select an org before running a query",
                "enter_query": "Enter a SOQL query",
                "query_failed": "Query failed",
                "org_created": "Org created",
                "org_updated": "Org updated",
                "org_deleted": "Org deleted",
                "delete_failed": "Failed to delete org",
                "fill_required": "Please fill all required fields",
                "enter_secret": "Enter the consumer secret for new orgs",
                "save_failed": "Unable to save org",
                "saved_queries_load_failed": "Unable to load saved queries",
                "saved_query_save_failed": "Unable to save query",
                "saved_query_delete_failed": "Unable to delete saved query",
                "saved_query_saved": "Saved query stored",
                "saved_query_deleted": "Saved query deleted",
                "saved_query_loaded": "Saved query loaded",
                "enter_saved_query_name": "Enter a name for the saved query",
                "metadata_fetch_failed": "Unable to load Salesforce objects",
                "fields_fetch_failed": "Unable to load Salesforce fields",
                "clause_exists": '"{clause}" is already present in the query',
                "field_already_selected": '"{field}" is already present in the SELECT clause',
                "query_history_load_failed": "Unable to load query history",
                "no_results_available": "Run a query first to use this action",
                "results_copy_csv_success": "Results copied as CSV",
                "results_copy_excel_success": "Results copied as Excel",
                "results_copy_failed": "Unable to copy results",
                "results_export_ready_csv": "CSV download started",
                "results_export_ready_excel": "Excel download started",
                "results_export_failed": "Unable to export results",
                "query_without_limit_where": "Add a WHERE or LIMIT clause before running the query.",
                "query_truncated": "Showing the first {limit} records. Additional records were omitted.",
            },
            "query": {
                "no_records": "No records returned.",
                "results": {
                    "copy_csv": "Copy as CSV",
                    "copy_excel": "Copy as Excel",
                    "export_csv": "Export CSV",
                    "export_excel": "Export Excel",
                },
            },
            "form": {"update_button": "Update org", "save_button": "Save org"},
            "confirm": {
                "delete_org": "Delete org {orgId}?",
                "query_without_limit_where": "Are you sure you want to run a query without LIMIT nor WHERE?",
            },
            "saved_queries": {"load": "Load", "delete": "Delete"},
            "autocomplete": {"insert": "Insert"},
            "history": {
                "filter_all": "All objects",
                "object_unknown": "Unknown object",
                "org_label": "Org",
            },
            "data_import": {
                "upload_success": "{label} loaded ({count} records).",
                "upload_failed": "Unable to load the selected file.",
                "remove_success": "{label} data cleared.",
                "remove_failed": "Unable to clear the selected data.",
                "status_failed": "Unable to refresh import status.",
                "fields_failed": "Unable to load fields for the selected object.",
                "autocomplete_failed": "Unable to load suggestions.",
                "missing_selection": "Select an object and field before searching.",
                "missing_value": "Enter a value to search.",
                "no_matches": "No records found for the requested value.",
                "errors": {
                    "invalid_file": "The file cannot be read.",
                    "missing_id": "The uploaded file must contain an Id column.",
                    "duplicate_headers": "The uploaded file contains duplicate column headers.",
                    "invalid_headers": "The uploaded file has invalid column headers.",
                    "invalid_workbook": "The Excel file could not be processed.",
                    "empty_file": "The uploaded file is empty.",
                    "missing_filename": "Select a file before uploading.",
                    "missing_file": "Select a file before uploading.",
                    "missing_parameters": "Missing required information.",
                    "unknown_object": "Unknown object.",
                    "missing_dependency": "Install the \"openpyxl\" package to read Excel files.",
                },
            },
            "account_explorer": {
                "parse_success": "Loaded {count} account IDs.",
                "parse_empty": "No valid account IDs were found.",
                "parse_failed": "Unable to process the provided accounts.",
                "run_success": "Explorer completed successfully.",
                "run_failed": "Unable to load related records.",
                "no_accounts": "Load at least one account ID.",
                "no_org": "Select an org before running the explorer.",
                "download_unavailable": "Run the explorer before downloading.",
                "orgs_failed": "Unable to load org list.",
                "fields_failed": "Unable to load fields for suggestions.",
                "run": {
                    "org_placeholder": "Select an org",
                    "generated_at": "Data generated {timestamp}",
                },
                "results": {
                    "empty_object": "No related records found.",
                    "account_label": "Account",
                    "accounts_badge": "{count} accounts",
                    "contact_point_sources": {
                        "contact": "Matched via Contact__c",
                        "individual": "Matched via ParentId",
                    },
                },
                "config_saved": "Explorer configuration saved.",
                "config_failed": "Unable to save the explorer configuration.",
                "errors": {
                    "missing_dependency": "Excel support is not installed. Install optional dependencies.",
                    "invalid_file": "The uploaded file could not be processed.",
                    "no_valid_ids": "No valid Account IDs were found.",
                    "invalid_accounts": "No valid Account IDs were provided.",
                    "run_failed": "Unable to load related records.",
                    "parse_failed": "Unable to process the provided accounts.",
                },
            },
        },
    },
    "it": {
        "language_name": "Italiano",
        "app": {"title": "SF Integrator"},
        "nav": {
            "brand": "SF Integrator",
            "query": "Query",
            "org_config": "Configurazione org",
            "data_import": "Importazione dati - Tutti i file",
            "account_explorer": "Esploratore account",
            "guide": "Guida",
            "settings": "Impostazioni",
        },
        "index": {
            "select_org": {
                "title": "Seleziona un'organizzazione",
                "description": "Scegli un'organizzazione configurata per eseguire query SOQL.",
                "connected_badge": "Connessa",
                "not_connected_badge": "Non connessa",
                "empty": "Nessuna organizzazione disponibile. Aggiungine una dalla pagina di configurazione.",
                "manage_button": "Gestisci organizzazioni",
            },
            "help": {
                "title": "Serve aiuto?",
                "description": "Segui la checklist di configurazione.",
                "guide_button": "Apri la guida",
            },
            "query": {
                "title": "Esploratore SOQL",
                "selected_org_label": "Organizzazione selezionata",
                "selected_org_placeholder": "Seleziona un'organizzazione",
                "soql_label": "Query SOQL",
                "soql_placeholder": "SELECT Id\nFROM Account",
                "run_button": "Esegui query",
                "run_button_bypass": "Esegui senza LIMIT/WHERE",
                "run_button_fetch_all": "Esegui fino a 500k record",
                "helpers": {
                    "add_limit": "Aggiungi LIMIT 100",
                    "add_order_by": "Aggiungi ORDER BY CreatedDate DESC",
                },
                "saved_queries": {
                    "title": "Query salvate",
                    "name_label": "Nome",
                    "name_placeholder": "La mia query SOQL",
                    "save_button": "Salva query",
                    "update_button": "Aggiorna query",
                    "reset_button": "Pulisci",
                    "empty": "Nessuna query salvata.",
                    "load_button": "Carica",
                    "delete_button": "Elimina",
                },
                "history": {
                    "title": "Cronologia query",
                    "filter_label": "Filtra per oggetto",
                    "filter_all": "Tutti gli oggetti",
                    "empty": "Nessuna query eseguita.",
                    "object_unknown": "Oggetto sconosciuto",
                    "org_label": "Org",
                },
                "suggestions": {
                    "title": "Campi suggeriti",
                    "empty": "Nessun suggerimento disponibile.",
                    "field_exists_toast": '"{field}" è già presente nell\'elenco SELECT',
                },
                "autocomplete": {
                    "title": "Autocompletamento",
                    "objects_label": "Oggetti",
                    "objects_placeholder": "Filtra oggetti",
                    "objects_empty": "Seleziona un'organizzazione per caricare gli oggetti.",
                    "fields_label": "Campi",
                    "fields_empty": "Seleziona un oggetto per vedere i campi.",
                    "loading": "Caricamento...",
                },
            },
        },
        "data_import": {
            "title": "Importazione dati - Tutti i file",
            "subtitle": "Carica i file esportati da Salesforce per esplorare come gli Account sono collegati agli altri record.",
            "upload": {
                "optional": "Opzionale",
                "instructions": "Carica un file esportato per rendere disponibile questo oggetto nell'esploratore.",
                "select_label": "Carica file",
                "not_loaded": "Nessun file caricato.",
                "file_label": "File",
                "record_count": "Record",
                "updated_at": "Caricato",
                "remove_button": "Rimuovi dati",
                "loaded_badge": "Caricato",
            },
            "search": {
                "title": "Esploratore relazioni",
                "object_label": "Oggetto",
                "field_label": "Campo",
                "value_label": "Valore",
                "value_placeholder": "Scrivi un valore da cercare",
                "submit": "Mostra relazioni",
                "reset": "Pulisci",
            },
            "results": {
                "title": "Record correlati",
                "placeholder": "Carica i file e avvia una ricerca per esplorare le relazioni.",
                "select_record": "Seleziona un record per vedere i campi.",
                "empty_object": "Nessun record disponibile per questo oggetto.",
                "fields_heading": "Campi",
                "related_heading": "Record collegati",
                "related_empty": "Nessun record collegato per questo record.",
                "match_badge": "Risultato ricerca",
            },
        },
        "account_explorer": {
            "title": "Esploratore relazioni account",
            "input": {
                "title": "Carica ID Account",
                "description": "Carica un file o incolla un elenco di ID Account (massimo {limit}).",
                "file_label": "Importa da file",
                "file_help": "Supporta file CSV o Excel con una colonna Id.",
                "text_label": "Incolla ID Account",
                "text_help": "Separa gli ID con virgole, spazi o nuove righe.",
                "parse_button": "Carica ID",
                "clear_button": "Pulisci",
                "preview_title": "ID Account selezionati",
                "preview_empty": "Nessun ID account caricato.",
                "preview_more": "+ {extra} ID aggiuntivi non mostrati",
            },
            "run": {
                "title": "Esegui esplorazione",
                "org_label": "Organizzazione Salesforce",
                "org_placeholder": "Seleziona un'organizzazione",
                "org_help": "Scegli un'organizzazione connessa per recuperare i record correlati.",
                "button": "Avvia esplorazione",
                "download": "Scarica JSON",
                "status_running": "Caricamento record correlati…",
                "generated_at": "Dati generati {timestamp}",
            },
                "results": {
                    "title": "Dati correlati",
                    "placeholder": "Carica gli ID account e avvia l'esploratore per vedere i risultati.",
                    "select_account": "Seleziona un account per visualizzare le relazioni.",
                    "fields_heading": "Campi account",
                    "related_heading": "Oggetti correlati",
                    "empty_object": "Nessun record correlato trovato.",
                    "missing_accounts": "Mancano {count} account: {ids}",
                    "accounts_badge": "{count} account",
                    "no_fields": "Nessun campo configurato.",
                    "no_id": "Nessun Id",
                    "no_objects": "Nessun oggetto selezionato per la visualizzazione.",
                    "open_wide_tree": "Apri vista albero ampia in una nuova scheda",
                    "tree_tab_title": "{account} — Vista albero",
                    "account_label": "Account",
                    "view": {
                        "label": "Vista risultati",
                        "list": "Elenco",
                        "tree": "Albero",
                    },
                    "contact_point_sources": {
                        "contact": "Collegato tramite Contact__c",
                        "individual": "Collegato tramite ParentId",
                    },
                },
                "setup": {
                    "button": "Configura",
                    "title": "Configura esploratore",
                    "description": "Personalizza gli oggetti e i campi mostrati nell'esploratore.",
                "objects_title": "Oggetti",
                "objects_help": "Riordina gli oggetti e scegli quali visualizzare. Gli oggetti nascosti vengono comunque interrogati.",
                "objects_empty": "Nessun oggetto disponibile.",
                "move_up": "Sposta su",
                "move_down": "Sposta giù",
                "show_label": "Mostra",
                "hidden_badge": "Nascosto",
                "fields_title": "Campi",
                "fields_help": "Seleziona fino a cinque campi da visualizzare per ciascun oggetto.",
                "field_placeholder": "Campo {index}",
                "org_label": "Org per suggerimenti campi",
                "org_placeholder": "Seleziona un'organizzazione (opzionale)",
                "org_help": "Usata per caricare suggerimenti di autocompletamento durante la modifica dei campi.",
                "alerts": {
                    "title": "Avvisi",
                    "description": "Evidenzia gli account quando i record collegati soddisfano condizioni personalizzate.",
                    "guide_link": "Apri la guida sugli avvisi",
                    "add_alert": "Aggiungi avviso",
                    "label": "Etichetta avviso",
                    "object": "Oggetto",
                    "object_placeholder": "Seleziona un oggetto",
                    "field": "Campo",
                    "operator": "Operatore",
                    "value": "Valore",
                    "value_placeholder": "Inserisci un valore",
                    "remove_alert": "Rimuovi avviso",
                    "remove_filter": "Rimuovi filtro",
                    "add_filter": "Aggiungi filtro",
                    "empty": "Nessun avviso configurato.",
                    "operators": {
                        "equals": "uguale a",
                        "equals_ignore_case": "uguale (ignora maiuscole/minuscole)",
                        "not_equals": "diverso da",
                        "contains": "contiene",
                        "not_contains": "non contiene",
                        "starts_with": "inizia con",
                        "blank": "è vuoto",
                        "not_blank": "non è vuoto",
                        "null": "è null",
                        "not_null": "non è null",
                    },
                },
                "view_title": "Vista predefinita",
                "view_help": "Scegli come mostrare i risultati di default.",
                "view_options": {"list": "Elenco", "tree": "Albero"},
                "contact_points": {
                    "title": "Associazione punti di contatto",
                    "description": "Scegli come collegare i record Contact Point agli oggetti correlati.",
                    "options": {
                        "contact": "Abbina tramite Contact__c",
                        "individual": "Abbina tramite ParentId",
                    },
                },
                "close": "Chiudi",
                "save_button": "Salva configurazione",
                "saving": "Salvataggio…",
                "saved": "Configurazione salvata.",
                "save_failed": "Impossibile salvare la configurazione.",
            },
        },
        "orgs": {
            "form": {
                "title": "Aggiungi o aggiorna un'organizzazione",
                "id_label": "ID organizzazione",
                "id_placeholder": "id-univoco",
                "id_help": "Usa un identificatore univoco (es. prod, sandbox1).",
                "label_label": "Nome visualizzato",
                "label_placeholder": "Org di produzione",
                "environment_label": "Ambiente",
                "environment_production": "Produzione (login.salesforce.com)",
                "environment_sandbox": "Sandbox (test.salesforce.com)",
                "environment_custom": "Dominio personalizzato",
                "environment_custom_placeholder": "https://tuo-dominio.my.salesforce.com",
                "environment_help": "Seleziona personalizzato per usare un URL My Domain.",
                "client_id_label": "Consumer Key (Client ID)",
                "client_secret_label": "Consumer Secret",
                "client_secret_help": "Lascia vuoto per mantenere il secret esistente durante la modifica.",
                "redirect_uri_label": "Redirect URI",
                "redirect_uri_placeholder": "https://tuoapp.com/oauth/callback",
                "scope_label": "Ambito OAuth",
                "scope_default": "full refresh_token",
                "save_button": "Salva organizzazione",
                "clear_button": "Pulisci modulo",
                "update_button": "Aggiorna organizzazione",
            },
            "table": {
                "title": "Organizzazioni configurate",
                "empty": "Nessuna organizzazione configurata.",
                "headers": {
                    "id": "ID",
                    "label": "Nome",
                    "environment": "Ambiente",
                    "status": "Stato",
                    "actions": "",
                },
                "connected_badge": "Connessa",
                "not_connected_badge": "Non connessa",
                "actions": {
                    "connect": "Connetti",
                    "edit": "Modifica",
                    "delete": "Elimina",
                },
            },
        },
        "guide": {
            "title": "Lista di controllo per l'integrazione OAuth Salesforce",
            "subtitle": "Segui questi passaggi per collegare l'app alla tua organizzazione Salesforce.",
            "sections": {
                "prepare": {
                    "title": "1. Prepara Salesforce",
                    "steps": [
                        "Accedi all'organizzazione Salesforce che vuoi integrare.",
                        "Vai su <strong>Setup &gt; Apps &gt; App Manager</strong> e fai clic su <strong>New Connected App</strong> (Lightning Experience) invece di <em>New Lightning App</em> o <em>New External Client App</em>.",
                        "Compila la sezione delle informazioni di base: inserisci un <strong>Connected App Name</strong> descrittivo, lascia che Salesforce generi automaticamente l'<strong>API Name</strong> e indica un <strong>Contact Email</strong>; i campi opzionali possono rimanere vuoti salvo necessità specifiche.",
                        "Abilita <strong>OAuth Settings for API Integration</strong> per mostrare le opzioni di integrazione.",
                        "Nelle impostazioni OAuth lascia selezionato <strong>Require Secret for Web Server Flow</strong>, mantieni vuota la lista <strong>Selected OAuth Scopes</strong> per ora e ignora i campi facoltativi come <em>Start URL</em> o <em>Callback URL for Lightning Apps</em>.",
                        "Imposta la <strong>Callback URL</strong> principale su <code>http://localhost:5000/oauth/callback</code> per lo sviluppo locale; in produzione sostituisci <code>localhost:5000</code> con il tuo host mantenendo il percorso <code>/oauth/callback</code>.",
                        "Aggiungi i seguenti ambiti OAuth alla lista <strong>Selected OAuth Scopes</strong>: <code>Full access (full)</code> e <code>Perform requests on your behalf at any time (refresh_token, offline_access)</code>. Altri ambiti possono restare non selezionati salvo necessità.",
                        "Salva la connected app e copia il <strong>Consumer Key</strong> e il <strong>Consumer Secret</strong>.",
                        "In <strong>Manage &gt; OAuth Policies</strong> assicurati che la policy sui refresh token ne consenta l'utilizzo.",
                    ],
                },
                "configure": {
                    "title": "2. Configura l'integratore",
                    "steps": [
                        "Apri la pagina <a href=\"{org_config_url}\">Configurazione org</a>.",
                        "Compila il modulo con:",
                        "Fai clic su <strong>Salva organizzazione</strong>.",
                        "Usa il pulsante <strong>Connetti</strong> nella tabella per avviare l'autorizzazione OAuth.",
                        "Quando richiesto, concedi l'accesso in Salesforce; verrai reindirizzato all'app.",
                    ],
                    "form_details": [
                        "<strong>ID organizzazione</strong>: un identificatore interno come <code>prod</code> o <code>dev</code>.",
                        "<strong>Nome visualizzato</strong>: il nome mostrato nell'interfaccia.",
                        "<strong>Ambiente</strong>: scegli Produzione, Sandbox o inserisci il tuo URL My Domain personalizzato.",
                        "<strong>Consumer Key</strong> e <strong>Consumer Secret</strong> della connected app.",
                        "<strong>Redirect URI</strong>: deve corrispondere alla callback configurata in Salesforce.",
                        "<strong>Ambito OAuth</strong>: il valore predefinito è <code>full refresh_token</code>; modificalo se necessario.",
                    ],
                },
                "query": {
                    "title": "3. Esegui query SOQL",
                    "steps": [
                        "Torna alla pagina <a href=\"{query_url}\">Query</a>.",
                        "Seleziona l'organizzazione appena autorizzata e incolla una query SOQL, ad esempio <code>SELECT Id, Name FROM Account LIMIT 10</code>.",
                        "Fai clic su <strong>Esegui query</strong> per lanciare l'operazione. I risultati compariranno nella tabella sotto il modulo.",
                        "Hai bisogno di più dati? Usa i pulsanti <strong>Esegui senza LIMIT/WHERE</strong> o <strong>Esegui fino a 500k record</strong> accanto a Esegui query per bypassare i controlli.",
                    ],
                },
                "account_alerts": {
                    "title": "4. Avvisi Account Explorer",
                    "intro": "Usa gli avvisi per contrassegnare account e record collegati quando rispettano i controlli di cui hai bisogno.",
                    "steps": [
                        "Apri l'<strong>Esploratore account</strong> e fai clic su <strong>Configura</strong>.",
                        "Scorri fino alla sezione <strong>Avvisi</strong> e seleziona <strong>Aggiungi avviso</strong> per creare una regola.",
                        "Inserisci un'etichetta descrittiva e aggiungi uno o più filtri. Ogni filtro include Oggetto, Campo, Operatore e Valore (lascia il Valore vuoto per operatori come <em>è vuoto</em> o <em>è null</em>).",
                        "Usa l'autocompletamento per definire condizioni complesse: ad esempio controlla che <code>Contact.Phone</code> non sia vuoto, confronta i ruoli o verifica le tipologie email SOL.",
                        "Salva la configurazione. Quando l'esploratore viene eseguito, gli account, i record e i campi corrispondenti diventano rossi e mostrano il motivo dell'avviso al passaggio del mouse.",
                    ],
                },
                "advanced": {
                    "title": "5. Gestisci risultati di grandi dimensioni",
                    "steps": [
                        "Scegli <strong>Esegui senza LIMIT/WHERE</strong> per lanciare query mirate senza la convalida predefinita quando ti fidi del tuo SOQL.",
                        "Usa <strong>Esegui fino a 500k record</strong> per richiedere più dati tramite l'API QueryAll di Salesforce (fino a 500.000 record) e prevedi tempi di esecuzione maggiori.",
                    ],
                },
            },
            "tip": {
                "title": "Suggerimento:",
                "content": "Per lo sviluppo locale imposta la callback su <code>http://localhost:5000/oauth/callback</code> e aggiungila all'elenco di callback consentite della connected app. In produzione aggiorna il nome host in base all'ambiente mantenendo il percorso <code>/oauth/callback</code> per completare correttamente il reindirizzamento.",
            },
        },
        "settings": {
            "title": "Impostazioni",
            "language_label": "Lingua",
            "theme_label": "Tema",
            "save_button": "Salva impostazioni",
            "saved": "Impostazioni aggiornate correttamente.",
            "account_explorer": {
                "title": "Campi esploratore account",
                "description": "Seleziona fino a cinque campi per oggetto da mostrare nei risultati dell'esploratore (le esecuzioni sono limitate a {limit} account).",
                "org_label": "Organizzazione per i suggerimenti",
                "org_placeholder": "Seleziona un'organizzazione (opzionale)",
                "org_help": "Usata per fornire suggerimenti di compilazione dei campi.",
                "field_help": "Scegli fino a cinque campi da mostrare per oggetto.",
                "field_placeholder": "Campo {index}",
                "save_button": "Salva selezione campi",
                "reset_button": "Reimposta",
                "loading": "Caricamento configurazione…",
                "load_failed": "Impossibile caricare la configurazione corrente.",
                "saved": "Configurazione dei campi salvata.",
                "save_failed": "Impossibile salvare la configurazione dei campi.",
                "toast_saved": "Campi dell'esploratore account salvati.",
            },
            "themes": {
                "classic": "Classico",
                "modern": "Moderno",
                "dark": "Scuro",
                "sci-fi": "Fantascienza",
            },
        },
        "frontend": {
            "toast": {
                "select_org": "Seleziona un'organizzazione prima di eseguire una query",
                "enter_query": "Inserisci una query SOQL",
                "query_failed": "Query non riuscita",
                "org_created": "Organizzazione creata",
                "org_updated": "Organizzazione aggiornata",
                "org_deleted": "Organizzazione eliminata",
                "delete_failed": "Impossibile eliminare l'organizzazione",
                "fill_required": "Compila tutti i campi obbligatori",
                "enter_secret": "Inserisci il consumer secret per le nuove organizzazioni",
                "save_failed": "Impossibile salvare l'organizzazione",
                "saved_queries_load_failed": "Impossibile caricare le query salvate",
                "saved_query_save_failed": "Impossibile salvare la query",
                "saved_query_delete_failed": "Impossibile eliminare la query salvata",
                "saved_query_saved": "Query salvata",
                "saved_query_deleted": "Query salvata eliminata",
                "saved_query_loaded": "Query salvata caricata",
                "enter_saved_query_name": "Inserisci un nome per la query salvata",
                "metadata_fetch_failed": "Impossibile caricare gli oggetti Salesforce",
                "fields_fetch_failed": "Impossibile caricare i campi Salesforce",
                "clause_exists": '"{clause}" è già presente nella query',
                "field_already_selected": '"{field}" è già presente nell\'elenco SELECT',
                "query_history_load_failed": "Impossibile caricare la cronologia delle query",
                "no_results_available": "Esegui prima una query per usare questa azione",
                "results_copy_csv_success": "Risultati copiati in formato CSV",
                "results_copy_excel_success": "Risultati copiati in formato Excel",
                "results_copy_failed": "Impossibile copiare i risultati",
                "results_export_ready_csv": "Download CSV avviato",
                "results_export_ready_excel": "Download Excel avviato",
                "results_export_failed": "Impossibile esportare i risultati",
                "query_without_limit_where": "Aggiungi una clausola WHERE o LIMIT prima di eseguire la query.",
                "query_truncated": "Visualizzazione limitata ai primi {limit} record. I successivi sono stati omessi.",
            },
            "query": {
                "no_records": "Nessun record restituito.",
                "results": {
                    "copy_csv": "Copia come CSV",
                    "copy_excel": "Copia come Excel",
                    "export_csv": "Esporta CSV",
                    "export_excel": "Esporta Excel",
                },
            },
            "form": {"update_button": "Aggiorna organizzazione", "save_button": "Salva organizzazione"},
            "confirm": {
                "delete_org": "Eliminare l'organizzazione {orgId}?",
                "query_without_limit_where": "Sei sicuro di voler eseguire una query senza LIMIT né WHERE?",
            },
            "saved_queries": {"load": "Carica", "delete": "Elimina"},
            "autocomplete": {"insert": "Inserisci"},
            "history": {
                "filter_all": "Tutti gli oggetti",
                "object_unknown": "Oggetto sconosciuto",
                "org_label": "Org",
            },
            "data_import": {
                "upload_success": "{label} caricato ({count} record).",
                "upload_failed": "Impossibile caricare il file selezionato.",
                "remove_success": "Dati di {label} rimossi.",
                "remove_failed": "Impossibile rimuovere i dati selezionati.",
                "status_failed": "Impossibile aggiornare lo stato di importazione.",
                "fields_failed": "Impossibile caricare i campi dell'oggetto selezionato.",
                "autocomplete_failed": "Impossibile caricare i suggerimenti.",
                "missing_selection": "Seleziona un oggetto e un campo prima di cercare.",
                "missing_value": "Inserisci un valore da cercare.",
                "no_matches": "Nessun record trovato per il valore richiesto.",
                "errors": {
                    "invalid_file": "Il file non può essere letto.",
                    "missing_id": "Il file caricato deve contenere la colonna Id.",
                    "duplicate_headers": "Il file caricato contiene intestazioni duplicate.",
                    "invalid_headers": "Il file caricato ha intestazioni non valide.",
                    "invalid_workbook": "Impossibile elaborare il file Excel.",
                    "empty_file": "Il file caricato è vuoto.",
                    "missing_filename": "Seleziona un file prima di caricare.",
                    "missing_file": "Seleziona un file prima di caricare.",
                    "missing_parameters": "Informazioni richieste mancanti.",
                    "unknown_object": "Oggetto sconosciuto.",
                    "missing_dependency": "Installa il pacchetto \"openpyxl\" per leggere i file Excel.",
                },
            },
            "account_explorer": {
                "parse_success": "Caricati {count} ID account.",
                "parse_empty": "Nessun ID account valido trovato.",
                "parse_failed": "Impossibile elaborare gli account indicati.",
                "run_success": "Esplorazione completata con successo.",
                "run_failed": "Impossibile caricare i record correlati.",
                "no_accounts": "Carica almeno un ID account.",
                "no_org": "Seleziona un'organizzazione prima di avviare l'esplorazione.",
                "download_unavailable": "Esegui l'esplorazione prima di scaricare.",
                "orgs_failed": "Impossibile caricare l'elenco delle organizzazioni.",
                "fields_failed": "Impossibile caricare i campi per i suggerimenti.",
                "run": {
                    "org_placeholder": "Seleziona un'organizzazione",
                    "generated_at": "Dati generati {timestamp}",
                },
                "results": {
                    "empty_object": "Nessun record correlato trovato.",
                    "account_label": "Account",
                    "accounts_badge": "{count} account",
                },
                "config_saved": "Configurazione esploratore salvata.",
                "config_failed": "Impossibile salvare la configurazione dell'esploratore.",
                "errors": {
                    "missing_dependency": "Il supporto Excel non è installato. Installa le dipendenze facoltative.",
                    "invalid_file": "Il file caricato non può essere elaborato.",
                    "no_valid_ids": "Nessun ID Account valido trovato.",
                    "invalid_accounts": "Non sono stati forniti ID Account validi.",
                    "run_failed": "Impossibile caricare i record correlati.",
                    "parse_failed": "Impossibile elaborare gli account indicati.",
                },
            },
        },
    },
}


def get_language_codes() -> list[str]:
    return list(_LANGUAGE_PACKS.keys())


def get_language_name(code: str) -> str:
    return _LANGUAGE_PACKS.get(code, {}).get("language_name", code)


def get_language_pack(code: str) -> Dict[str, Any]:
    return deepcopy(_LANGUAGE_PACKS.get(code, _LANGUAGE_PACKS[DEFAULT_LANGUAGE]))


def translate(key: str, language: str | None = None) -> str:
    for code in filter(None, [language, DEFAULT_LANGUAGE]):
        pack = _LANGUAGE_PACKS.get(code)
        if not pack:
            continue
        value: Any = pack
        found = True
        for part in key.split('.'):
            if isinstance(value, dict) and part in value:
                value = value[part]
            else:
                found = False
                break
        if found and isinstance(value, str):
            return value
    return key


def _deep_merge(base: Dict[str, Any], override: Dict[str, Any]) -> Dict[str, Any]:
    for key, value in override.items():
        if (
            key in base
            and isinstance(base[key], dict)
            and isinstance(value, dict)
        ):
            base[key] = _deep_merge(base[key], value)
        else:
            base[key] = deepcopy(value)
    return base


def get_frontend_translations(language: str) -> Dict[str, Any]:
    base_pack = _LANGUAGE_PACKS.get(DEFAULT_LANGUAGE, {})
    frontend = deepcopy(base_pack.get("frontend", {}))

    extra_sections = ("account_explorer", "settings")
    for key in extra_sections:
        value = base_pack.get(key)
        if isinstance(value, dict):
            frontend[key] = deepcopy(value)

    if language == DEFAULT_LANGUAGE:
        return frontend

    language_pack = _LANGUAGE_PACKS.get(language, {})

    frontend_override = language_pack.get("frontend")
    if isinstance(frontend_override, dict):
        frontend = _deep_merge(frontend, deepcopy(frontend_override))

    for key in extra_sections:
        override = language_pack.get(key)
        if isinstance(override, dict):
            existing = frontend.get(key, {})
            if not isinstance(existing, dict):
                existing = {}
            frontend[key] = _deep_merge(existing, deepcopy(override))

    return frontend

